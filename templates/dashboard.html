<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Dashboard</title>
		<style>
			:root {
				color-scheme: dark;
			}

			body {
				font-family: "Courier New", "Nimbus Mono L", "IBM Plex Mono",
					"Times New Roman", serif;
				font-size: 1.1rem;
				letter-spacing: 0.02em;
				margin: 0;
				padding: 2.5rem;
				background: #0f172a;
				color: #f8fafc;
			}

			h1 {
				font-size: 2.5rem;
				margin-bottom: 1.5rem;
				text-transform: uppercase;
				letter-spacing: 0.12em;
			}

			section {
				margin-bottom: 2rem;
			}

			.section-header {
				display: flex;
				justify-content: space-between;
				align-items: baseline;
				margin-bottom: 0.75rem;
			}

			.section-header h2 {
				margin: 0;
				font-size: 1.5rem;
				letter-spacing: 0.08em;
			}

			.section-header span {
				font-size: 0.95rem;
				color: #94a3b8;
			}

			.metrics-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 1rem;
			}

			.metric-card {
				background: rgba(10, 15, 30, 0.85);
				border: 1px solid #1f2933;
				padding: 1.25rem;
				border-radius: 0.5rem;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
			}

			.metric-label {
				text-transform: uppercase;
				font-size: 0.85rem;
				letter-spacing: 0.1em;
				margin-bottom: 0.5rem;
				color: #94a3b8;
			}

			.metric-value {
				font-size: 1.75rem;
				margin: 0 0 0.75rem;
			}

			.bar {
				width: 100%;
				height: 0.5rem;
				background: rgba(255, 255, 255, 0.1);
				border-radius: 999px;
				overflow: hidden;
			}

			.bar-fill {
				height: 100%;
				background: linear-gradient(90deg, #06b6d4, #22d3ee);
				width: 0%;
				transition: width 0.4s ease;
			}

			.metric-subtext {
				margin: 0.25rem 0 0;
				font-size: 0.95rem;
				color: #cbd5f5;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				background: rgba(10, 15, 30, 0.8);
				backdrop-filter: blur(8px);
				border: 1px solid #1f2933;
			}

			th,
			td {
				padding: 1rem 1.25rem;
				border: 1px solid #1f2430;
				text-align: left;
				font-size: 1.05rem;
			}

			th {
				background: rgba(15, 20, 35, 0.9);
				font-weight: 700;
				letter-spacing: 0.08em;
				text-transform: uppercase;
			}

			tbody tr:nth-child(even) {
				background: rgba(17, 24, 39, 0.65);
			}

			tbody tr:hover {
				background: rgba(31, 41, 55, 0.9);
			}

			.status-up {
				color: #6de38d;
				font-weight: 700;
			}

			.status-down {
				color: #ff6b6b;
				font-weight: 700;
			}

			.status-unknown {
				color: #cbd5f5;
				font-weight: 700;
			}

			.checked {
				color: #94a3b8;
				font-size: 0.95rem;
			}
		</style>
	</head>
	<body>
		<h1>Infeliz3000 Dashboard</h1>
		<section>
			<div class="section-header">
				<h2>System Metrics</h2>
				<span>Updated <span id="system-updated">—</span></span>
			</div>
			<div class="metrics-grid">
				<div class="metric-card">
					<p class="metric-label">CPU Usage</p>
					<p class="metric-value" id="cpu-usage-value">—%</p>
					<div class="bar"><div class="bar-fill" id="cpu-usage-bar"></div></div>
					<p class="metric-subtext" id="cpu-temp">Temp: —</p>
				</div>
				<div class="metric-card">
					<p class="metric-label">Memory</p>
					<p class="metric-value" id="memory-usage-value">—%</p>
					<div class="bar">
						<div class="bar-fill" id="memory-usage-bar"></div>
					</div>
					<p class="metric-subtext" id="memory-detail">— / —</p>
				</div>
				<div class="metric-card">
					<p class="metric-label">Disk</p>
					<p class="metric-value" id="disk-usage-value">—%</p>
					<div class="bar">
						<div class="bar-fill" id="disk-usage-bar"></div>
					</div>
					<p class="metric-subtext" id="disk-detail">— / —</p>
				</div>
				<div class="metric-card">
					<p class="metric-label">Uptime</p>
					<p class="metric-value" id="uptime-value">—</p>
					<p class="metric-subtext">System heartbeat</p>
				</div>
			</div>
		</section>

		<section>
			<div class="section-header">
				<h2>Services</h2>
				<span>Auto-refresh every 3s</span>
			</div>
			<table>
				<thead>
					<tr>
						<th>Service</th>
						<th>URL</th>
						<th>Status</th>
						<th>Last Checked</th>
					</tr>
				</thead>
				<tbody>
					{% for service in services %}
					<tr data-service="{{ service.key }}">
						<td>{{ service.name }}</td>
						<td>{{ service.url }}</td>
						<td class="status status-unknown">Pending…</td>
						<td class="checked">—</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</section>

		<script>
			const services = {{ services | tojson }};

			const statusClasses = {
				up: "status-up",
				down: "status-down",
				unknown: "status-unknown",
			};

			const systemElements = {
				cpuValue: document.getElementById("cpu-usage-value"),
				cpuBar: document.getElementById("cpu-usage-bar"),
				cpuTemp: document.getElementById("cpu-temp"),
				memoryValue: document.getElementById("memory-usage-value"),
				memoryBar: document.getElementById("memory-usage-bar"),
				memoryDetail: document.getElementById("memory-detail"),
				diskValue: document.getElementById("disk-usage-value"),
				diskBar: document.getElementById("disk-usage-bar"),
				diskDetail: document.getElementById("disk-detail"),
				uptimeValue: document.getElementById("uptime-value"),
				updated: document.getElementById("system-updated"),
			};

			function setStatus(row, state, label) {
				if (!row) {
					return;
				}
				const cell = row.querySelector(".status");
				cell.classList.remove(...Object.values(statusClasses));
				cell.classList.add(statusClasses[state] || statusClasses.unknown);
				cell.textContent = label;
				row.querySelector(".checked").textContent =
					new Date().toLocaleTimeString();
			}

			function clampPercent(value) {
				if (!Number.isFinite(value)) {
					return 0;
				}
				return Math.min(100, Math.max(0, value));
			}

			function updateBar(element, percent) {
				if (!element) {
					return;
				}
				element.style.width = `${clampPercent(percent)}%`;
			}

			function formatBytes(bytes) {
				if (!Number.isFinite(bytes)) {
					return "—";
				}
				const units = ["B", "KB", "MB", "GB", "TB", "PB"];
				let value = bytes;
				let unitIndex = 0;
				while (value >= 1024 && unitIndex < units.length - 1) {
					value /= 1024;
					unitIndex += 1;
				}
				return `${value.toFixed(1)} ${units[unitIndex]}`;
			}

			function formatDuration(seconds) {
				if (!Number.isFinite(seconds)) {
					return "—";
				}
				const d = Math.floor(seconds / 86400);
				const h = Math.floor((seconds % 86400) / 3600);
				const m = Math.floor((seconds % 3600) / 60);
				const parts = [];
				if (d) parts.push(`${d}d`);
				parts.push(`${h}h`);
				parts.push(`${m}m`);
				return parts.join(" ");
			}

			function setSystemError(message) {
				const fallback = message || "Unavailable";
				systemElements.cpuValue.textContent = fallback;
				systemElements.memoryValue.textContent = fallback;
				systemElements.diskValue.textContent = fallback;
				systemElements.memoryDetail.textContent = fallback;
				systemElements.diskDetail.textContent = fallback;
				systemElements.cpuTemp.textContent = "Temp: —";
				systemElements.uptimeValue.textContent = fallback;
				systemElements.updated.textContent = "—";
				updateBar(systemElements.cpuBar, 0);
				updateBar(systemElements.memoryBar, 0);
				updateBar(systemElements.diskBar, 0);
			}

			async function pollServices() {
				const rows = services.map((service) =>
					document.querySelector(`[data-service="${service.key}"]`)
				);
				rows.forEach((row) => setStatus(row, "unknown", "Checking…"));

				try {
					const response = await fetch("/api/status");
					if (!response.ok) {
						throw new Error(`Status request failed: ${response.status}`);
					}
					const payload = await response.json();
					(payload.services || []).forEach((item) => {
						const row = document.querySelector(`[data-service="${item.key}"]`);
						setStatus(row, item.status || "unknown", item.message || "Unknown");
					});
				} catch (error) {
					rows.forEach((row) => setStatus(row, "down", "Status API error"));
				}
			}

			async function pollSystem() {
				try {
					const response = await fetch("/api/system");
					if (!response.ok) {
						throw new Error(`System request failed: ${response.status}`);
					}
					const payload = await response.json();

					const cpuPercent = Math.round(payload.cpu?.usage_percent ?? 0);
					systemElements.cpuValue.textContent = `${cpuPercent}%`;
					updateBar(systemElements.cpuBar, cpuPercent);
					const temp = payload.cpu?.temperature_c;
					systemElements.cpuTemp.textContent =
						temp !== null && temp !== undefined
							? `Temp: ${temp.toFixed(1)} °C`
							: "Temp: —";

					const memPercent = Math.round(payload.memory?.percent ?? 0);
					systemElements.memoryValue.textContent = `${memPercent}%`;
					updateBar(systemElements.memoryBar, memPercent);
					systemElements.memoryDetail.textContent = `${formatBytes(
						payload.memory?.used
					)} / ${formatBytes(payload.memory?.total)}`;

					const diskPercent = Math.round(payload.disk?.percent ?? 0);
					systemElements.diskValue.textContent = `${diskPercent}%`;
					updateBar(systemElements.diskBar, diskPercent);
					systemElements.diskDetail.textContent = `${formatBytes(
						payload.disk?.used
					)} / ${formatBytes(payload.disk?.total)}`;

					systemElements.uptimeValue.textContent = formatDuration(
						payload.uptime_seconds
					);
					systemElements.updated.textContent = new Date().toLocaleTimeString();
				} catch (error) {
					setSystemError("System API error");
				}
			}

			function startPolling() {
				pollServices();
				pollSystem();
				setInterval(() => {
					pollServices();
					pollSystem();
				}, 3000);
			}

			startPolling();
		</script>
	</body>
</html>
